--- linux-2.6.9/net/ipv4/netfilter/ip_nat_snmp_basic.c~	2006-07-28 22:53:37.000000000 +0200
+++ linux-2.6.9/net/ipv4/netfilter/ip_nat_snmp_basic.c	2006-07-28 22:54:02.000000000 +0200
@@ -997,12 +997,12 @@
 		
 	return 1;
 
+err_addr_free:
+	kfree((unsigned long *)trap->ip_address);
+
 err_id_free:
 	kfree(trap->id);
 
-err_addr_free:
-	kfree((unsigned long *)trap->ip_address);
-	
 	return 0;
 }
 
@@ -1120,11 +1120,10 @@
 		struct snmp_v1_trap trap;
 		unsigned char ret = snmp_trap_decode(&ctx, &trap, map, check);
 		
-		/* Discard trap allocations regardless */
-		kfree(trap.id);
-		kfree((unsigned long *)trap.ip_address);
-		
-		if (!ret)
+		if (ret) {
+			kfree(trap.id);
+			kfree((unsigned long *)trap.ip_address);
+		} else 
 			return ret;
 		
 	} else {
